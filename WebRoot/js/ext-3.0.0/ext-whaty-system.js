Ext.namespace("Ext.whaty.services.system.AllocateRoleGrid");Ext.whaty.services.system.AllocateRoleGrid=Ext.extend(Ext.whaty.ux.grid.LogicQueryPageGrid,{proxyAutoLoad:false,localmsg:{roleIdText:"role ID",roleNameText:"role Name"},viewConfig:{forceFit:true},ActionUrl:"/services/system/RoleAction",allowAdd:false,allowDelete:false,initComponent:function(){this.cmField=[{header:this.localmsg.roleIdText,dataIndex:"roleId",width:100},{header:this.localmsg.roleNameText,dataIndex:"roleName",width:100}];Ext.whaty.services.system.AllocateRoleGrid.superclass.initComponent.call(this);this.addEvents("rowSelectedOrNot")},selModelRowSelectedOrNot:function(){var flag=false;var selectedRecords=this.getSelectedRecords();if(selectedRecords!=null&&selectedRecords.length>=1){this.fireEvent("rowSelectedOrNot",false)}else{this.fireEvent("rowSelectedOrNot",true)}Ext.whaty.services.system.AllocateRoleGrid.superclass.selModelRowSelectedOrNot.call(this)}});Ext.namespace("Ext.whaty.services.system.AllocateRoleWindow");Ext.whaty.services.system.AllocateRoleWindow=Ext.extend(Ext.whaty.ux.window.BaseWindow,{localmsg:{titleText:"Allocate Role To User",deleteText:"Delete",allocateText:"Allocate",roleAllocateText:"Roles",allocatedRoleText:"Allocated Role",searchTipText:"Role Name Search ",messageText:"Message",AddSuccessText:"Add Success !",AddFailureText:"Add Failure !",DelSuccessText:"Delete Success !",DelFailureText:"Delete Failure !",DeleteMsgText:"Are You Sure To Delete ?"},closeAction:"hide",modal:true,width:820,height:400,allowSave:false,layout:"border",selectedPriority:null,initComponent:function(){Ext.applyIf(this.localmsg,Ext.whaty.ux.window.BaseWindow.prototype.localmsg);this.title=this.localmsg.titleText;this.delUserRoleBtn=new Ext.Button({text:this.localmsg.deleteText,iconCls:"delete",disabled:true,listeners:{scope:this,click:this._deleteAllocatedRole}});this.saveAllocateRoleBtn=new Ext.Button({text:this.localmsg.allocateText,disabled:true,iconCls:"portlet_add",listeners:{scope:this,click:this._saveAllocateRole}});this.centerGrid=new Ext.whaty.services.system.AllocateRoleGrid({allowSearch:true,searchFieldName:"roleName",searchToolTip:{text:this.localmsg.searchTipText},title:this.localmsg.roleAllocateText,region:"center",toolbar:[this.saveAllocateRoleBtn],listeners:{scope:this,rowSelectedOrNot:function(flag){this.saveAllocateRoleBtn.setDisabled(flag)}}});this.allocatedGrid=new Ext.whaty.services.system.AllocateRoleGrid({allowSearch:true,searchFieldName:"roleName",searchToolTip:{text:this.localmsg.searchTipText},proxyAutoLoad:false,title:'<font color="green">'+this.localmsg.allocatedRoleText+"</font>",proxyUrl:CONTEXT_PATH+"/services/system/UserAction_getUserRoles.action",region:"west",width:400,toolbar:[this.delUserRoleBtn],listeners:{scope:this,rowSelectedOrNot:function(flag){this.delUserRoleBtn.setDisabled(flag)}}});this.items=[this.centerGrid,this.allocatedGrid];Ext.whaty.services.system.AllocateRoleWindow.superclass.initComponent.call(this)},showAllocateRoleWindow:function(user){this.user=user;this.show();this.centerGrid.reload();this.allocatedGrid.reload({username:user.username})},_deleteAllocatedRole:function(){Ext.MessageBox.confirm(this.localmsg.messageText,this.localmsg.DeleteMsgText,function(btn){if(btn=="yes"){var username=this.user.username;var records=this.allocatedGrid.getSelectedRecords();var roleIdArr=[];for(var i=0;i<records.length;i++){roleIdArr.push(records[i].get("roleId"))}var roleIds=roleIdArr.join(",");var _url=CONTEXT_PATH+"/services/system/RoleAction_deleteUserRole.action";var _params={roleIds:roleIds,username:username};var response=ExtUtil.doAjax({url:_url,params:_params});if(response.logicSuccess){ExtUtil.alert(this.localmsg.messageText,this.localmsg.DelSuccessText);this.allocatedGrid.reload()}else{ExtUtil.alert(this.localmsg.messageText,this.localmsg.DelFailureText)}}},this)},_saveAllocateRole:function(){var username=this.user.username;var records=this.centerGrid.getSelectedRecords();var roleIdArr=[];var roleNameArr=[];for(var i=0;i<records.length;i++){roleIdArr.push(records[i].get("roleId"))}var roleIds=roleIdArr.join(",");var roleNames=roleNameArr.join(",");var _url=CONTEXT_PATH+"/services/system/RoleAction_saveUserRole.action";var _params={username:username,roleIds:roleIds};var response=ExtUtil.doAjax({url:_url,params:_params});if(response.logicSuccess){ExtUtil.alert(this.localmsg.messageText,this.localmsg.AddSuccessText);this.allocatedGrid.reload()}else{ExtUtil.alert(this.localmsg.messageText,this.localmsg.AddFailureText)}}});Ext.namespace("Ext.whaty.services.system.menu.MenuForm");Ext.whaty.services.system.menu.MenuForm=Ext.extend(Ext.whaty.ux.form.BaseForm,{actionType:"Add",actionUrl:CONTEXT_PATH+"/services/system/MenuAction_extMergeEntity.action",initComponent:function(){this.idHidden=new Ext.form.Hidden({fieldLabel:"id",name:"entityBean.id"});this.parentId=new Ext.form.Hidden({fieldLabel:"parentId",name:"entityBean.parentId",value:"root"});this.menuId=new Ext.form.TextField({fieldLabel:"菜单Id ",allowBlank:false,name:"entityBean.menuId",anchor:"60%",listeners:{scope:this,blur:this._validateMenuId}});this.menuName=new Ext.form.TextField({fieldLabel:"菜单名称",allowBlank:false,name:"entityBean.text",anchor:"60%"});var typeJsonData={root:[{text:"系统菜单",value:"system"},{text:"业务菜单",value:"business"}]};this.menuType=new Ext.whaty.ux.form.WhatyComboBox({fieldLabel:"菜单类型",allowBlank:false,hiddenName:"entityBean.menuType",jsonData:typeJsonData,value:"business",anchor:"40%"});this.menuTip=new Ext.form.TextField({fieldLabel:"菜单tip说明",name:"entityBean.qtip",anchor:"60%"});this.menuUrl=new Ext.form.TextField({fieldLabel:"菜单url",name:"entityBean.url",anchor:"60%"});var targetJsonData={root:[{text:"新窗口",value:"open"},{text:"新Panel",value:"location"}]};this.menuTargettype=new Ext.whaty.ux.form.WhatyComboBox({fieldLabel:"打开类型",allowBlank:false,hiddenName:"entityBean.targetType",jsonData:targetJsonData,value:"location",anchor:"40%"});this.menuLeaf=new Ext.form.RadioGroup({fieldLabel:"是否叶子菜单",allowBlank:false,columns:2,name:"entityBean.leaf",items:[{boxLabel:"是",name:"entityBean.leaf",inputValue:"true",checked:true},{boxLabel:"否",name:"entityBean.leaf",inputValue:"false"}],anchor:"30%"});this.menuIframe=new Ext.form.RadioGroup({fieldLabel:"是否使用iFrame",allowBlank:false,columns:2,name:"entityBean.useframe",items:[{boxLabel:"是",name:"entityBean.useframe",inputValue:"true"},{boxLabel:"否",name:"entityBean.useframe",inputValue:"false",checked:true}],anchor:"30%"});this.menuActive=new Ext.form.RadioGroup({fieldLabel:"菜单是否可用",allowBlank:false,columns:2,name:"entityBean.active",items:[{boxLabel:"是",name:"entityBean.active",inputValue:"true",checked:true},{boxLabel:"否",name:"entityBean.active",inputValue:"false"}],anchor:"30%"});this.menuParams=new Ext.form.TextField({fieldLabel:"传递的参数",name:"entityBean.params",anchor:"60%"});this.menuDescription=new Ext.form.TextArea({fieldLabel:"菜单描述",name:"entityBean.description",anchor:"60%"});this.saveBtn=new Ext.Button({text:"保存",iconCls:"save",listeners:{scope:this,click:this._mergeMenu}});this.resetBtn=new Ext.Button({text:"重置",iconCls:"reset",listeners:{scope:this,click:this._resetForm}});this.items=[this.idHidden,this.parentId,this.menuId,this.menuName,this.menuType,this.menuTargettype,this.menuLeaf,this.menuIframe,this.menuActive,this.menuUrl,this.menuParams,this.menuTip,this.menuDescription];this.buttons=[this.saveBtn,this.resetBtn];Ext.whaty.services.system.menu.MenuForm.superclass.initComponent.call(this)},_mergeMenu:function(){if(this.actionType=="Add"){var _menuId=this.menuId.getValue();var _url=CONTEXT_PATH+"/services/system/MenuAction_validateMenuId.action";var config={url:_url,params:{menuId:_menuId}};var response=ExtUtil.doAjax(config);var isConflict=response.isConflict;if(isConflict){ExtUtil.alert("消息","该菜单ID已存在,请重新输入！")}else{this.submitForm()}}else{this.submitForm()}},_resetForm:function(){this.getForm().reset()},_validateMenuId:function(field){if(this.actionType=="Add"){var _menuId=field.getValue();var _url=CONTEXT_PATH+"/services/system/MenuAction_validateMenuId.action";var config={url:_url,params:{menuId:_menuId}};var response=ExtUtil.doAjax(config);var isConflict=response.isConflict;if(isConflict){ExtUtil.alert("消息","该菜单ID已存在,请重新输入！")}}},setMenuIdReadOnly:function(readOnly){ExtUtil.setFormItemReadOnly(this.menuId,readOnly)}});Ext.namespace("Ext.whaty.services.system.menu.MenuTree");Ext.whaty.services.system.menu.MenuTree=Ext.extend(Ext.whaty.framework.TreeMenuPanel,{rootVisible:true,actionType:"Add",initComponent:function(){this.contextmenu=new Ext.menu.Menu({items:[{text:"添加",iconCls:"add",scope:this,handler:this._doAddMenu},{text:"删除",iconCls:"delete",scope:this,handler:this._doDeleteMenu}]});Ext.whaty.services.system.menu.MenuTree.superclass.initComponent.call(this);this.on("contextmenu",this._showContextmenu);this.on("click",this._menuTreeClick)},_showContextmenu:function(node,event){event.preventDefault();node.select();this.contextmenu.showAt(event.getXY())},_menuTreeClick:function(node){if(node!=this.root){var _url=CONTEXT_PATH+"/services/system/MenuAction_getMenuByMenuId.action";var config={url:_url,params:{menuId:node.id}};var response=ExtUtil.doAjax(config);var menu=response.menu;var menuForm=Ext.getCmp("MenuForm");menuForm.actionType="Update";this.actionType="Update";menuForm.setFormValueWithObject(menu,"entityBean");menuForm.setMenuIdReadOnly(true)}},_doAddMenu:function(){var node=this.getSelectionModel().getSelectedNode();var menuForm=Ext.getCmp("MenuForm");menuForm.actionType="Add";this.actionType="Add";menuForm.resetForm();menuForm.setMenuIdReadOnly(false);menuForm.parentId.setValue(node.id)},_doDeleteMenu:function(){Ext.MessageBox.confirm("消息","确定删除?",function(btn){if(btn=="yes"){var node=this.getSelectionModel().getSelectedNode();var _url=CONTEXT_PATH+"/services/system/MenuAction_deleteMenuByMenuId.action";var config={url:_url,params:{menuId:node.id}};var response=ExtUtil.doAjax(config);if(response.deleteSuccess){ExtUtil.alert("消息","删除成功",1000);node.remove()}else{ExtUtil.alert("消息","删除失败",1000)}}},this)},mergeMenuNode:function(jsonObj){var node=this.getSelectionModel().getSelectedNode();if(node==null){node=this.root}if(this.actionType=="Add"){var newNode=new Ext.tree.TreeNode({id:jsonObj.menu.menuId,text:jsonObj.menu.text});node.appendChild(newNode)}else{node.setText(jsonObj.menu.text);node.setId(jsonObj.menu.menuId)}}});Ext.namespace("Ext.whaty.services.system.priority.PriorityMenuWindow");Ext.whaty.services.system.priority.PriorityMenuWindow=Ext.extend(Ext.whaty.ux.window.BaseWindow,{title:"权限菜单分配",closeAction:"hide",modal:true,layout:"border",width:820,height:400,allowSave:false,selectedPriority:null,initComponent:function(){this.delMenuBtn=new Ext.Button({text:"删除",iconCls:"delete",disabled:true,listeners:{scope:this,click:this._deleteSelectedMenu}});this.selectedTree=new Ext.whaty.framework.TreeMenuPanel({title:'<font color="green">已分配菜单</font>',menus:null,animate:false,region:"west",width:400,checked:false,rootVisible:true,listeners:{scope:this,checkchange:this._selectedTreeCheckchange},toolbar:["-",this.delMenuBtn]});this.saveMenuBtn=new Ext.Button({text:"分配",disabled:true,iconCls:"portlet_add",listeners:{scope:this,click:this._savePriorityMenu}});this.menuTree=new Ext.whaty.framework.TreeMenuPanel({title:"菜单",region:"center",checked:false,animate:false,menus:All_Menus,rootVisible:true,listeners:{scope:this,checkchange:this._menuTreeCheckchange},toolbar:["-",this.saveMenuBtn]});this.items=[this.menuTree,this.selectedTree];Ext.whaty.services.system.priority.PriorityMenuWindow.superclass.initComponent.call(this)},_selectedTreeCheckchange:function(node,checked){this.selectedTree.removeListener("checkchange",this._selectedTreeCheckchange,this);this._checkChildrenNode(node,checked);this.selectedTree.addListener("checkchange",this._selectedTreeCheckchange,this);var cks=this.selectedTree.getChecked();if(cks!=null&&cks.length>0){this.delMenuBtn.setDisabled(false)}else{this.delMenuBtn.setDisabled(true)}},_checkChildrenNode:function(node,checked){if(node.getUI().isChecked()!=checked){node.getUI().toggleCheck(checked)}if(node.hasChildNodes()){node.expand(false);for(var i=0;i<node.childNodes.length;i++){var n=node.childNodes[i];this._checkChildrenNode(n,checked)}}else{return}},_menuTreeCheckchange:function(node,checked){this.menuTree.removeListener("checkchange",this._menuTreeCheckchange,this);this._checkParentNode(node,checked);if(!checked){this._checkChildrenNode(node,checked)}this.menuTree.addListener("checkchange",this._menuTreeCheckchange,this);var cks=this.menuTree.getChecked();if(cks!=null&&cks.length>0){this.saveMenuBtn.setDisabled(false)}else{this.saveMenuBtn.setDisabled(true)}},_checkParentNode:function(node,checked){if(node.parentNode!=null){if(!checked){if(!this._validAnyChildChecked(node.parentNode)){if(node.parentNode.getUI().isChecked()!=checked){node.parentNode.getUI().toggleCheck(checked)}}}else{if(node.parentNode.getUI().isChecked()!=checked){node.parentNode.getUI().toggleCheck(checked)}}this._checkParentNode(node.parentNode,checked)}else{return}},_validAnyChildChecked:function(node){var flag=false;for(var i=0;i<node.childNodes.length;i++){var n=node.childNodes[i];if(n.getUI().isChecked()){flag=true;break}}return flag},_deleteSelectedMenu:function(){Ext.MessageBox.confirm("消息","确定删除?",function(btn){if(btn=="yes"){var cks=this.selectedTree.getChecked();var ckIds=[];for(var i=0;i<cks.length;i++){ckIds.push(cks[i].id)}var priId=this.selectedPriority.priId;var menuIds=ckIds.join(",");var _url=CONTEXT_PATH+"/services/system/PriorityAction_deletePriorityMenu.action";var _params={priId:priId,menuIds:menuIds};var response=ExtUtil.doAjax({url:_url,params:_params});if(response.logicSuccess){ExtUtil.alert("消息","删除成功！");this.reloadSelectedTree(priId)}else{ExtUtil.alert("消息","删除失败！")}}},this)},_savePriorityMenu:function(){var cks=this.menuTree.getChecked();var ckIds=[];for(var i=0;i<cks.length;i++){ckIds.push(cks[i].id)}var priId=this.selectedPriority.priId;var menuIds=ckIds.join(",");var _url=CONTEXT_PATH+"/services/system/PriorityAction_doPriorityMenuSave.action";var _params={priId:priId,menuIds:menuIds};var response=ExtUtil.doAjax({url:_url,params:_params});if(response.logicSuccess){this.reloadSelectedTree(priId);ExtUtil.alert("消息","分配成功！")}else{ExtUtil.alert("消息","分配失败！")}},showPriorityMenuWindow:function(priority){this.selectedPriority=priority;this.show();this.reloadSelectedTree(priority.priId)},reloadSelectedTree:function(priId){var _url=CONTEXT_PATH+"/services/system/PriorityAction_getMenuTreeOfPriority.action";var _params={priId:priId};var response=ExtUtil.doAjax({url:_url,params:_params});if(response.logicSuccess){this.selectedTree.reloadTreeMenu(response.menus);this.selectedTree.expandAll()}else{ExtUtil.alert("消息","获取菜单失败")}}});Ext.namespace("Ext.whaty.services.system.priority.PriorityMenuTree");Ext.whaty.services.system.priority.PriorityMenuTree=Ext.extend(Ext.whaty.framework.TreeMenuPanel,{initComponent:function(){Ext.whaty.services.system.priority.PriorityMenuTree.superclass.initComponent.call(this);this.on("contextmenu",this._showContextmenu)}});Ext.namespace("Ext.whaty.services.system.PrioritySearchForm");Ext.whaty.services.system.PrioritySearchForm=Ext.extend(Ext.whaty.ux.form.BaseSearchForm,{labelAlign:"right",initComponent:function(){this.nameTF=new Ext.form.TextField({fieldLabel:"权限ID",name:"priId",anchor:"90%"});this.pwdTF=new Ext.form.TextField({fieldLabel:"权限名称",name:"priName",anchor:"90%"});var priTypeData={root:[{text:"菜单权限",value:"menu"},{text:"操作权限",value:"operate"}]};this.priTypeCb=new Ext.whaty.ux.form.WhatyComboBox({fieldLabel:"权限类型",name:"priType",hiddenName:"priType",jsonData:priTypeData,anchor:"90%",listeners:{scope:this,beforeselect:this._priTypeBeforeselect}});this.items=[{layout:"column",items:[{width:300,layout:"form",items:this.nameTF},{width:300,layout:"form",items:this.pwdTF},{width:300,layout:"form",items:this.priTypeCb}]}];Ext.whaty.services.system.PrioritySearchForm.superclass.initComponent.call(this)},_priTypeBeforeselect:function(cb,record,index){var param=new Object();param.priType=record.get("value");this.fireEvent("search",param)}});Ext.namespace("Ext.whaty.services.system.PriorityGrid");Ext.whaty.services.system.PriorityGrid=Ext.extend(Ext.whaty.ux.grid.LogicQueryPageGrid,{ActionUrl:"/services/system/PriorityAction",beanWindowFormConfig:{title:"权限管理",height:300,width:400},initComponent:function(){this.priMenuBtn=new Ext.Button({text:"分配菜单",disabled:true,iconCls:"portlet_add",listeners:{scope:this,click:this._doSelectMenu}});this.toolbar=[this.priMenuBtn];var priTypeData={root:[{text:"菜单权限",value:"menu"},{text:"操作权限",value:"operate"}]};this.cmField=[{header:"权限ID",dataIndex:"priId",width:100,fieldtype:"textfield",fieldAttr:{id:"System_PriorityId",allowBlank:false,regex:/^(PRI_)[A-Za-z_-]+$/,regexText:"请以PRI_开头，输入字母、下划线、减号",listeners:{scope:this,blur:this._doIdBlur}}},{header:"权限名称",dataIndex:"priName",width:100,fieldtype:"textfield",fieldAttr:{id:"System_PriorityName",allowBlank:false,regex:/^[A-Za-z\u4E00-\u9FA5_-]+$/,regexText:"请输入中文、下划线、减号",listeners:{scope:this,blur:this._doNameBlur}}},{header:"权限类型",dataIndex:"priType",width:100,renderer:this._priTypeRenderer,fieldtype:"whatycombobox",fieldAttr:{allowBlank:false,hiddenName:"priType",jsonData:priTypeData,value:"menu"}}];this.win=new Ext.whaty.services.system.priority.PriorityMenuWindow();Ext.whaty.services.system.PriorityGrid.superclass.initComponent.call(this)},_priTypeRenderer:function(value){if(value=="menu"){return"菜单权限"}else{if(value=="operate"){return"操作权限"}else{return value}}},afterFormWindowShow:function(){var codeTF=Ext.getCmp("System_PriorityId");var actionType=this.getFormWindowActionType();if(actionType=="update"){ExtUtil.setFormItemReadOnly(codeTF,true)}else{ExtUtil.setFormItemReadOnly(codeTF,false)}},_doIdBlur:function(field){var actionType=this.getFormWindowActionType();var value=field.getValue();if(field.isValid()&&!ExtUtil.isEmpty(value)&&actionType=="add"){var config={url:CONTEXT_PATH+"/services/system/PriorityAction_validatePriId.action",params:{priId:value}};var response=ExtUtil.doAjax(config);if(!response.validateSuccess){ExtUtil.alert("消息","权限编码  '"+value+"' 已经存在，请重新输入！")}}},_doNameBlur:function(field){var actionType=this.getFormWindowActionType();var value=field.getValue();if(field.isValid()&&!ExtUtil.isEmpty(value)){var id=null;if(actionType=="update"){var record=this.getSelectedRecord();id=record.get("id")}var config={url:CONTEXT_PATH+"/services/system/PriorityAction_validatePriName.action",params:{priName:value,actionType:actionType,id:id}};var response=ExtUtil.doAjax(config);if(!response.validateSuccess){ExtUtil.alert("消息","权限编码  '"+value+"' 已经存在，请重新输入！")}}},selModelRowSelectedOrNot:function(){var selectedRecords=this.getSelectedRecords();if(selectedRecords!=null&&selectedRecords.length==1){this.priMenuBtn.setDisabled(false)}else{this.priMenuBtn.setDisabled(true)}Ext.whaty.services.system.PriorityGrid.superclass.selModelRowSelectedOrNot.call(this)},_doSelectMenu:function(){var record=this.getSelectedRecord();this.win.showPriorityMenuWindow(record.data)}});Ext.namespace("Ext.whaty.services.system.AllocatePriorityWindow");Ext.whaty.services.system.AllocatePriorityWindow=Ext.extend(Ext.whaty.ux.window.BaseWindow,{title:"角色权限分配",closeAction:"hide",modal:true,width:820,height:400,allowSave:false,layout:"border",selectedPriority:null,initComponent:function(){this.delPriorityRoleBtn=new Ext.Button({text:"删除",iconCls:"delete",disabled:true,listeners:{scope:this,click:this._deleteAllocatedPriority}});this.saveAllocatePriorityBtn=new Ext.Button({text:"分配",disabled:true,iconCls:"portlet_add",listeners:{scope:this,click:this._saveAllocatePriority}});this.centerGrid=new Ext.whaty.services.system.AllocatePriorityGrid({title:"权限",region:"center",allowSearch:true,searchFieldName:"priName",searchToolTip:{text:"权限名称搜索"},toolbar:[this.saveAllocatePriorityBtn],listeners:{scope:this,rowSelectedOrNot:function(flag){this.saveAllocatePriorityBtn.setDisabled(flag)}}});this.allocatedGrid=new Ext.whaty.services.system.AllocatePriorityGrid({allowSearch:true,searchFieldName:"pri_name",searchToolTip:{text:"权限名称搜索"},proxyAutoLoad:false,title:'<font color="green">已分配权限</font>',proxyUrl:CONTEXT_PATH+"/services/system/RoleAction_getPriorityOfRole.action",region:"west",width:400,toolbar:[this.delPriorityRoleBtn],listeners:{scope:this,rowSelectedOrNot:function(flag){this.delPriorityRoleBtn.setDisabled(flag)}}});this.items=[this.centerGrid,this.allocatedGrid];Ext.whaty.services.system.AllocatePriorityWindow.superclass.initComponent.call(this)},showAllocatePriorityWindow:function(role){this.role=role;this.show();this.centerGrid.reload();this.allocatedGrid.reload({roleId:role.roleId})},_deleteAllocatedPriority:function(){Ext.MessageBox.confirm("消息","确定删除?",function(btn){if(btn=="yes"){var roleId=this.role.roleId;var records=this.allocatedGrid.getSelectedRecords();var priIdArr=[];for(var i=0;i<records.length;i++){priIdArr.push(records[i].get("priId"))}var priIds=priIdArr.join(",");var _url=CONTEXT_PATH+"/services/system/RoleAction_deleteRolePriority.action";var _params={priIds:priIds,roleId:roleId};var response=ExtUtil.doAjax({url:_url,params:_params});if(response.logicSuccess){ExtUtil.alert("消息","删除成功！");this.allocatedGrid.reload()}else{ExtUtil.alert("消息","删除失败！")}}},this)},_saveAllocatePriority:function(){var roleId=this.role.roleId;var records=this.centerGrid.getSelectedRecords();var priIdArr=[];var priNameArr=[];for(var i=0;i<records.length;i++){priIdArr.push(records[i].get("priId"))}var priIds=priIdArr.join(",");var _url=CONTEXT_PATH+"/services/system/RoleAction_saveRolePriority.action";var _params={priIds:priIds,roleId:roleId};var response=ExtUtil.doAjax({url:_url,params:_params});if(response.logicSuccess){ExtUtil.alert("消息","分配成功！");this.allocatedGrid.reload()}else{ExtUtil.alert("消息","分配失败！")}}});Ext.namespace("Ext.whaty.services.system.AllocatePriorityGrid");Ext.whaty.services.system.AllocatePriorityGrid=Ext.extend(Ext.whaty.ux.grid.LogicQueryPageGrid,{ActionUrl:"/services/system/PriorityAction",viewConfig:{forceFit:true},title:"权限",allowAdd:false,allowDelete:false,initComponent:function(){this.cmField=[{header:"权限ID",dataIndex:"priId",width:100},{header:"权限名称",dataIndex:"priName",width:100}];Ext.whaty.services.system.AllocatePriorityGrid.superclass.initComponent.call(this);this.addEvents("rowSelectedOrNot")},selModelRowSelectedOrNot:function(){var flag=false;var selectedRecords=this.getSelectedRecords();if(selectedRecords!=null&&selectedRecords.length>=1){this.fireEvent("rowSelectedOrNot",false)}else{this.fireEvent("rowSelectedOrNot",true)}Ext.whaty.services.system.AllocatePriorityGrid.superclass.selModelRowSelectedOrNot.call(this)},_saveAllocatePriority:function(){}});Ext.namespace("Ext.whaty.services.system.role.RoleForm");Ext.whaty.services.system.role.RoleForm=Ext.extend(Ext.whaty.ux.form.BaseForm,{actionUrl:CONTEXT_PATH+"/services/system/RoleAction_extMergeEntity.action",initComponent:function(){this.idHidden=new Ext.form.Hidden({fieldLabel:"id",name:"entityBean.id"});this.roleId=new Ext.form.TextField({fieldLabel:"角色Id ",allowBlank:false,name:"entityBean.roleId",anchor:"50%"});this.roleName=new Ext.form.TextField({fieldLabel:"角色名称",allowBlank:false,name:"entityBean.roleName",anchor:"50%"});var typeJsonData={root:[{text:"教师",value:"teacher"},{text:"学生",value:"teacher"}]};this.roleType=new Ext.whaty.ux.form.WhatyComboBox({fieldLabel:"角色类型",allowBlank:false,hiddenName:"entityBean.roleType",jsonData:typeJsonData,value:"教师",anchor:"50%"});this.roleDiscription=new Ext.form.TextField({fieldLabel:"角色描述",allowBlank:false,name:"entityBean.description",anchor:"50%"});this.saveBtn=new Ext.Button({text:"保存",iconCls:"save",listeners:{scope:this,click:this._mergeMenu}});this.resetBtn=new Ext.Button({text:"重置",iconCls:"reset",listeners:{scope:this,click:this._resetForm}});this.items=[this.idHidden,this.roleId,this.roleName,this.roleType,this.roleDiscription];this.buttons=[this.saveBtn,this.resetBtn];Ext.whaty.services.system.menu.MenuForm.superclass.initComponent.call(this)},_mergeMenu:function(){this.submitForm()},_resetForm:function(){}});Ext.namespace("Ext.whaty.services.system.RoleSearchForm");Ext.whaty.services.system.RoleSearchForm=Ext.extend(Ext.whaty.ux.form.BaseSearchForm,{labelAlign:"right",initComponent:function(){this.roleId=new Ext.form.TextField({fieldLabel:"角色ID",name:"roleId",anchor:"90%"});this.roleName=new Ext.form.TextField({fieldLabel:"角色名称",name:"roleName",anchor:"90%"});var roleTypeData={root:[{text:"系统角色",value:"system"},{text:"业务角色",value:"business"}]};this.roleType=new Ext.whaty.ux.form.WhatyComboBox({fieldLabel:"角色类型",name:"roleType",hiddenName:"roleType",jsonData:roleTypeData,anchor:"90%",listeners:{scope:this,beforeselect:this._roleTypeBeforeselect}});this.items=[{layout:"column",items:[{width:300,layout:"form",items:this.roleId},{width:300,layout:"form",items:this.roleName},{width:300,layout:"form",items:this.roleType}]}];Ext.whaty.services.system.RoleSearchForm.superclass.initComponent.call(this)},_roleTypeBeforeselect:function(cb,record,index){var param=new Object();param.roleType=record.get("value");this.fireEvent("search",param)}});Ext.namespace("Ext.whaty.services.system.RoleGrid");Ext.whaty.services.system.RoleGrid=Ext.extend(Ext.whaty.ux.grid.LogicQueryPageGrid,{ActionUrl:"/services/system/RoleAction",beanWindowFormConfig:{title:"角色管理",height:400,width:500},initComponent:function(){this.priRoleBtn=new Ext.Button({text:"分配权限",disabled:true,iconCls:"portlet_add",listeners:{scope:this,click:this._doSelectPri}});this.toolbar=[this.priRoleBtn];var roleTypeData={root:[{text:"系统角色",value:"system"},{text:"业务角色",value:"business"}]};this.cmField=[{header:"角色ID",dataIndex:"roleId",width:100,fieldtype:"textfield",fieldAttr:{id:"System_RoleId",allowBlank:false,regex:/^(ROLE_)[A-Za-z_-]+$/,regexText:"请以ROLE_开头，输入字母、下划线",listeners:{scope:this,blur:this._doIdBlur}}},{header:"角色名称",dataIndex:"roleName",width:100,fieldtype:"textfield",fieldAttr:{allowBlank:false,regex:/^[A-Za-z\u4E00-\u9FA5_-]+$/,regexText:"请输入中文",listeners:{scope:this,blur:this._doNameBlur}}},{header:"角色类型",dataIndex:"roleType",width:100,renderer:this._roleTypeRender,fieldtype:"whatycombobox",fieldAttr:{allowBlank:false,hiddenName:"roleType",jsonData:roleTypeData,value:"system"}},{header:"角色描述",dataIndex:"description",width:100,fieldtype:"textarea",fieldAttr:{width:200}}];this.win=new Ext.whaty.services.system.AllocatePriorityWindow();Ext.whaty.services.system.RoleGrid.superclass.initComponent.call(this)},_roleTypeRender:function(value){if(value=="system"){return"系统角色"}else{if(value=="business"){return"业务角色"}else{return value}}},afterFormWindowShow:function(){var roleTf=Ext.getCmp("System_RoleId");var actionType=this.getFormWindowActionType();if(actionType=="update"){ExtUtil.setFormItemReadOnly(roleTf,true)}else{ExtUtil.setFormItemReadOnly(roleTf,false)}},_doSelectPri:function(){var roleRecord=this.getSelectedRecord();this.win.showAllocatePriorityWindow(roleRecord.data)},selModelRowSelectedOrNot:function(){var selectedRecords=this.getSelectedRecords();if(selectedRecords!=null&&selectedRecords.length==1){this.priRoleBtn.setDisabled(false)}else{this.priRoleBtn.setDisabled(true)}Ext.whaty.services.system.RoleGrid.superclass.selModelRowSelectedOrNot.call(this)},_doIdBlur:function(field){var actionType=this.getFormWindowActionType();var value=field.getValue();if(field.isValid()&&!ExtUtil.isEmpty(value)&&actionType=="add"){var config={url:CONTEXT_PATH+"/services/system/RoleAction_validateRoleId.action",params:{roleId:value}};var response=ExtUtil.doAjax(config);if(response.isConflict){ExtUtil.alert("消息","已经存在，请重新输入！")}}},_doNameBlur:function(field){var id=null;var actionType=this.getFormWindowActionType();if(actionType=="update"){var record=this.getSelectedRecord();id=record.get("id")}var value=field.getValue();if(field.isValid()&&!ExtUtil.isEmpty(value)){var config={url:CONTEXT_PATH+"/services/system/RoleAction_validateRoleName.action",params:{roleName:value,actionType:actionType,id:id}};var response=ExtUtil.doAjax(config);if(response.isConflict){ExtUtil.alert("消息","已经存在，请重新输入！")}}}});Ext.namespace("Ext.whaty.services.system.UserSearchForm");Ext.whaty.services.system.UserSearchForm=Ext.extend(Ext.whaty.ux.form.BaseSearchForm,{labelAlign:"right",initComponent:function(){this.loginId=new Ext.form.TextField({fieldLabel:"用户名",name:"username",anchor:"90%"});this.realName=new Ext.form.TextField({fieldLabel:"姓名",name:"realName",anchor:"90%"});this.email=new Ext.form.TextField({fieldLabel:"邮箱",name:"email",anchor:"90%"});this.mobilephone=new Ext.form.TextField({fieldLabel:"手机",name:"mobilephone",anchor:"90%"});var userTypeData={root:[{text:"老师",value:"teacher"},{text:"学生",value:"student"}]};this.userType=new Ext.whaty.ux.form.WhatyComboBox({fieldLabel:"用户类型",name:"userType",hiddenName:"userType",jsonData:userTypeData,anchor:"90%",listeners:{scope:this,beforeselect:this._userTypeBeforeselect}});this.items=[{layout:"column",items:[{width:333,layout:"form",items:this.loginId},{width:333,layout:"form",items:this.realName},{width:334,layout:"form",items:this.email}]},{layout:"column",items:[{width:333,layout:"form",items:this.mobilephone},{width:333,layout:"form",items:this.userType}]}];Ext.whaty.services.system.UserSearchForm.superclass.initComponent.call(this)},_userTypeBeforeselect:function(cb,record,index){var param=new Object();param.userType=record.get("value");this.fireEvent("search",param)}});Ext.namespace("Ext.whaty.services.system.UserGrid");Ext.whaty.services.system.UserGrid=Ext.extend(Ext.whaty.ux.grid.LogicQueryPageGrid,{ActionUrl:"/services/system/UserAction",beanWindowFormConfig:{title:"用户管理",height:400,width:500},initComponent:function(){this.userRoleBtn=new Ext.Button({text:"分配角色",disabled:true,iconCls:"portlet_add",listeners:{scope:this,click:this._doSelectRole}});this.resetPwdBtn=new Ext.Button({text:"重置密码",disabled:true,iconCls:"portlet_add",listeners:{scope:this,click:this._resetPwd}});this.toolbar=[this.userRoleBtn,this.resetPwdBtn];var userTypeData={root:[{text:"普通用户",value:"user"},{text:"系统管理员",value:"admin"}]};var userStateData={root:[{text:"认证",value:"1"},{text:"未认证",value:"0"}]};var radioItems=[{boxLabel:"男",inputValue:1,checked:true},{boxLabel:"女",inputValue:0}];this.cmField=[{header:"用户名",dataIndex:"username",width:100,fieldtype:"textfield",fieldAttr:{anchor:"80%",allowBlank:false,regex:/^[A-Za-z0-9_-]+$/,regexText:"请输入字母、下划线、减号、数字",listeners:{scope:this,blur:this._doIdBlur}}},{header:"真实姓名",dataIndex:"realName",width:100,fieldtype:"textfield",fieldAttr:{anchor:"80%"}},{header:"性别",dataIndex:"sex",width:50,renderer:this._sexRenderer,fieldtype:"radiogroup",fieldAttr:{items:radioItems,anchor:"50%"}},{header:"手机号",dataIndex:"mobilephone",width:100,fieldtype:"textfield",fieldAttr:{anchor:"80%",regex:/^[0-9]{9,11}$/,regexText:"请正确输入手机号"}},{header:"固定电话",dataIndex:"homenumber",width:100,fieldtype:"textfield",fieldAttr:{anchor:"80%",regex:/^(\d{11})|^((\d{7,8})|(\d{4}|\d{3})-(\d{7,8})|(\d{4}|\d{3})-(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1})|(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1}))$/,regexText:"请输入正确固定电话"}},{header:"邮箱",dataIndex:"email",width:100,fieldtype:"textfield",fieldAttr:{anchor:"80%",allowBlank:false,regex:/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/,regexText:"邮箱格式不正确",listeners:{scope:this,blur:this._doEmailBlur}}},{header:"通信地址",hidden:true,dataIndex:"address",width:100,fieldtype:"textfield",fieldAttr:{anchor:"80%"}},{header:"用户状态",dataIndex:"state",width:50,renderer:this._userStateRenderer,fieldtype:"whatycombobox",fieldAttr:{allowBlank:false,hiddenName:"state",jsonData:userStateData,value:"1"}},{header:"用户类型",dataIndex:"userType",width:50,renderer:this._userTypeRenderer,fieldtype:"whatycombobox",fieldAttr:{allowBlank:false,hiddenName:"userType",jsonData:userTypeData,value:"user"}},{header:"创建时间",dataIndex:"createtime",width:100}];this.win=new Ext.whaty.services.system.AllocateRoleWindow();Ext.whaty.services.system.UserGrid.superclass.initComponent.call(this)},_sexRenderer:function(value){return value==1?"男":"女"},_userTypeRenderer:function(value){if(value=="student"){return"学生"}else{if(value=="teacher"){return"老师"}else{if(value=="supadmin"){return"超级管理员"}else{if(value=="admin"){return"管理员"}else{return"普通用户"}}}}},_userStateRenderer:function(value){return value==1?"认证":"未认证"},_doIdBlur:function(field){var id=null;var actionType=this.getFormWindowActionType();if(actionType=="update"){var record=this.getSelectedRecord();id=record.get("id")}var value=field.getValue();if(field.isValid()&&!ExtUtil.isEmpty(value)){var config={url:CONTEXT_PATH+"/services/system/UserAction_validateUsername.action",params:{username:value,actionType:actionType,id:id}};var response=ExtUtil.doAjax(config);if(response.isConflict){ExtUtil.alert("消息","用户名 :"+value+" 已经存在，请重新输入！")}}},_doEmailBlur:function(field){var id=null;var actionType=this.getFormWindowActionType();if(actionType=="update"){var record=this.getSelectedRecord();id=record.get("id")}var value=field.getValue();if(field.isValid()&&!ExtUtil.isEmpty(value)){var config={url:CONTEXT_PATH+"/services/system/UserAction_validateEmail.action",params:{email:value,actionType:actionType,id:id}};var response=ExtUtil.doAjax(config);if(response.isConflict){ExtUtil.alert("消息","邮箱  : "+value+" 已经存在，请重新输入！")}}},_doSelectRole:function(){var userRecord=this.getSelectedRecord();this.win.showAllocateRoleWindow(userRecord.data)},_resetPwd:function(){Ext.MessageBox.confirm("消息","确定重置?",function(btn){if(btn=="yes"){var userRecords=this.getSelectedRecords();var userArr=[];for(var i=0;i<userRecords.length;i++){userArr.push(userRecords[i].get("username"))}var usernames=userArr.join(",");var config={url:CONTEXT_PATH+"/services/system/UserAction_resetPassword.action",params:{usernames:usernames}};var response=ExtUtil.doAjax(config);if(response.logicSuccess){ExtUtil.alert("消息","重置成功！")}else{ExtUtil.alert("消息","重置失败！")}}},this)},selModelRowSelectedOrNot:function(){var selectedRecords=this.getSelectedRecords();if(selectedRecords!=null&&selectedRecords.length==1){this.userRoleBtn.setDisabled(false);this.resetPwdBtn.setDisabled(false)}else{this.userRoleBtn.setDisabled(true);this.resetPwdBtn.setDisabled(true)}if(selectedRecords!=null&&selectedRecords.length>=1){this.resetPwdBtn.setDisabled(false)}else{this.resetPwdBtn.setDisabled(true)}Ext.whaty.services.system.UserGrid.superclass.selModelRowSelectedOrNot.call(this)}});